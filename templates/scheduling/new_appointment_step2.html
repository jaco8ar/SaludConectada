{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/styles/scheduling/appointment_booking.css">

<div class="booking-container">
  <!-- Step Indicator -->
  <div class="step-indicator">
    <div class="step completed">
      <div class="step-number">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <div class="step-label">Seleccionar médico y fecha</div>
    </div>
    <div class="step-divider completed"></div>
    <div class="step active">
      <div class="step-number">2</div>
      <div class="step-label">Confirmar horario</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="booking-content">
    <div class="booking-header">
      <h2>Nueva cita - Paso 2</h2>
      <p>Selecciona el horario que mejor te convenga</p>
    </div>

    <!-- Selected Info -->
    <div class="selected-info-card">
      <div class="info-item">
        <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <div>
          <span class="info-label">Médico</span>
          <span class="info-value">{{ doctor }}</span>
        </div>
      </div>
      <div class="info-item">
        <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <div>
          <span class="info-label">Fecha seleccionada</span>
          <span class="info-value">{{ date|date:'l j \d\e F' }}</span>
        </div>
      </div>
    </div>

    <!-- Nearby Days Calendar -->
    {% if availability_calendar %}
    <div class="calendar-section">
      <h3>Días cercanos con disponibilidad</h3>
      <div class="calendar-grid">
        {% for d, count in availability_calendar %}
        <div class="calendar-day {% if count > 0 %}available{% else %}unavailable{% endif %} {% if d == date %}current{% endif %}">
          {% if count > 0 %}
            <a href="{% url 'scheduling:new_appointment_step2' %}?doctor={{ doctor.id }}&date={{ d|date:'Y-m-d' }}">
              <div class="day-date">{{ d|date:'j' }}</div>
              <div class="day-name">{{ d|date:'D' }}</div>
              <div class="day-slots">{{ count }} slot{{ count|pluralize }}</div>
              {% if d == date %}
                <div class="current-badge">Actual</div>
              {% endif %}
            </a>
          {% else %}
            <div class="day-disabled">
              <div class="day-date">{{ d|date:'j' }}</div>
              <div class="day-name">{{ d|date:'D' }}</div>
              <div class="day-slots">Sin horarios</div>
            </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Time Slot Selection -->
    <div class="booking-form-card">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="doctor" value="{{ doctor.id }}">
        <input type="hidden" name="date" value="{{ date|date:'Y-m-d' }}">

        {% if form.slot.field.choices %}
        <div class="form-group">
          <label class="form-label">
            <svg class="label-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Horarios disponibles
          </label>
          <div class="time-slots-grid">
            {% for value, label in form.slot.field.choices %}
            <label class="time-slot-option">
              <input type="radio" name="slot" value="{{ value }}" required>
              <span class="time-slot-label">{{ label }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="empty-state">
          <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p>No hay horarios disponibles para este día.</p>
        </div>
        {% endif %}

        <div class="form-group">
          <label for="{{ form.reason.id_for_label }}" class="form-label">
            <svg class="label-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Motivo de la consulta (opcional)
          </label>
          {{ form.reason }}
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" {% if not form.slot.field.choices %}disabled{% endif %}>
            Confirmar cita
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </button>
          <a href="{% url 'scheduling:new_appointment_step1' %}?doctor={{ doctor.id }}&date={{ date|date:'Y-m-d' }}" class="btn-secondary">
            Cambiar médico o fecha
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
